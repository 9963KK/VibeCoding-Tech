---
name: JVibe:keepgo
description: 自动继续推进项目任务，基于当前文档进度
---

# /JVibe:keepgo - 自动推进下一步

用户只需反复执行此命令，系统自动识别状态并推进开发。

## 核心理念

```
用户不需要思考"下一步做什么"
只需要不断说 "keepgo"，AI 自动判断并执行
```

**关键特性**：
- **主动推进**：不卡住等用户，自动执行下一步
- **阶段确认**：在关键节点请求用户确认
- **依赖感知**：按模块依赖顺序规划和开发

---

## 用户确认点

keepgo 在以下阶段会暂停请求用户确认：

| 阶段 | 确认内容 | 确认后继续 |
|------|----------|-----------|
| **功能规划完成** | 列出为当前模块规划的功能列表 | 调用 planner 创建 TODO |
| **功能实现完成** | 展示已完成的功能和代码改动 | 继续下一个功能 |
| **模块完成** | 汇总模块所有功能完成情况 | 开始下一个模块 |

---

## 状态流转图

```
未初始化
    ↓ 提示 /JVibe:init
刚初始化
    ↓ 自动进入功能规划
功能规划中（主 agent）
    ↓ 规划模块功能列表
    ↓ ⏸️ 用户确认
有功能待规划
    ↓ 调用 planner agent 创建 TODO
有功能待开始 (❌)
    ↓ 调用 developer agent
有功能开发中 (🚧)
    ↓ 逐个完成 TODO
功能即将完成
    ↓ ⏸️ 用户确认
    ↓ 标记 ✅
模块完成
    ↓ ⏸️ 用户确认
    ↓ 开始下一个模块
全部完成
```

---

## 状态-动作映射表

| 状态 | 判断条件 | 执行者 | 动作 |
|------|----------|--------|------|
| **未初始化** | `docs/core/` 不存在 | - | 提示 `/JVibe:init` |
| **刚初始化** | `firstSessionAfterInit=true` | 主 agent | 读取模块依赖，进入功能规划 |
| **功能规划中** | 当前模块无功能规划 | 主 agent | 规划功能列表 → **请求确认** |
| **有功能待规划** | 功能已确认但无 TODO | **planner** | 创建 F-XXX 条目和 TODO |
| **有功能待开始** | 有 ❌ 功能，无 🚧 | **developer** | 开始执行第一个 TODO |
| **有功能开发中** | 有 🚧 功能 | **developer** | 执行下一个 `[ ]` TODO |
| **功能即将完成** | 🚧 功能所有 TODO 已 `[x]` | 主 agent | 标记 ✅ → **请求确认** |
| **模块完成** | 当前模块所有功能 ✅ | 主 agent | 汇总 → **请求确认** → 下一模块 |
| **全部完成** | 所有功能 ✅ | - | 提示项目完成 |

---

## 执行流程详解

### 阶段 1：未初始化

```
检测：docs/core/ 目录不存在
动作：不执行
输出：提示先运行 /JVibe:init
```

### 阶段 2：刚初始化 → 进入功能规划

```
检测：.jvibe-state.json 的 firstSessionAfterInit=true
动作：
  1. 更新 firstSessionAfterInit 为 false
  2. 读取项目文档中的模块依赖关系
  3. 选择依赖链底层的模块作为起始模块
  4. 进入"功能规划中"状态
```

### 阶段 3：功能规划中（主 agent 执行）

```
检测：当前模块没有规划功能
执行者：主 agent（不调用 planner）
动作：
  1. 分析模块职责和边界（从项目文档）
  2. 规划该模块应包含的功能列表（3-6个功能）
  3. 使用 AskUserQuestion 请求确认：
     "为 [模块名] 规划了以下功能，是否确认？"
     - 功能1：xxx
     - 功能2：xxx
     ...
输出：功能规划列表，等待用户确认
```

**确认选项**：
```yaml
questions:
  - question: "以上功能规划是否确认？"
    header: "确认规划"
    multiSelect: false
    options:
      - label: "确认，开始创建 TODO"
        description: "使用当前规划，调用 planner 创建详细 TODO"
      - label: "需要调整"
        description: "修改功能列表后再继续"
      - label: "跳过此模块"
        description: "暂时不开发此模块，进入下一个"
```

### 阶段 4：有功能待规划 → 创建 TODO

```
检测：功能已确认，但功能清单中无对应 F-XXX 条目
执行者：planner agent
动作：
  1. 逐个调用 planner agent
  2. 为每个功能创建 F-XXX 条目
  3. 生成详细 TODO 列表
输出：创建了 N 个功能条目
```

### 阶段 5：有功能待开始 (❌)

```
检测：功能清单有 ❌ 状态功能，无 🚧
执行者：developer agent
动作：
  1. 选择第一个 ❌ 功能
  2. 调用 developer agent
  3. 将状态改为 🚧
  4. 执行第一个 TODO
输出：开始了哪个功能，完成了哪个 TODO
```

### 阶段 6：有功能开发中 (🚧)

```
检测：功能清单有 🚧 状态功能
执行者：developer agent
动作：
  1. 找到 🚧 功能的 TODO 列表
  2. 调用 developer agent
  3. 执行第一个未完成 [ ] 的 TODO
  4. 完成后将 [ ] 改为 [x]
输出：完成了哪个 TODO，当前进度
```

### 阶段 7：功能即将完成 → 用户确认

```
检测：🚧 功能的所有 TODO 都是 [x]
动作：
  1. 展示功能完成情况
  2. 使用 AskUserQuestion 请求确认：
     "F-XXX [功能名] 已完成，请核对"
输出：功能完成详情，等待确认
```

**确认选项**：
```yaml
questions:
  - question: "功能实现是否符合预期？"
    header: "确认完成"
    multiSelect: false
    options:
      - label: "确认完成"
        description: "标记功能为完成，继续下一个"
      - label: "需要补充"
        description: "添加额外 TODO 后再完成"
      - label: "需要修改"
        description: "对已实现的代码进行调整"
```

### 阶段 8：模块完成 → 用户确认

```
检测：当前模块所有功能都是 ✅
动作：
  1. 汇总模块完成情况
  2. 使用 AskUserQuestion 请求确认
  3. 确认后进入下一个模块的功能规划
输出：模块完成汇总，下一模块预览
```

### 阶段 9：全部完成

```
检测：所有模块的所有功能都是 ✅
动作：不执行
输出：项目所有功能已完成，建议添加新功能
```

---

## 模块依赖排序

读取项目文档中的模块依赖关系，按**拓扑排序**确定开发顺序：

```
示例依赖：
  OrderModule → ProductModule → AuthModule
  OrderModule → CustomerModule → AuthModule

排序结果（底层优先）：
  1. AuthModule（无依赖）
  2. ProductModule（依赖 Auth）
  3. CustomerModule（依赖 Auth）
  4. OrderModule（依赖 Product + Customer）
```

---

## Agent 调用规则

| 任务类型 | 调用谁 | 说明 |
|----------|--------|------|
| 规划模块包含哪些功能 | **主 agent** | 分析模块职责，输出功能列表 |
| 创建功能 TODO 列表 | **planner agent** | 生成 F-XXX 条目和详细 TODO |
| 执行 TODO 任务 | **developer agent** | 写代码、勾选完成项 |
| 用户确认交互 | **主 agent** | 使用 AskUserQuestion |

---

## 输出格式

### 正常执行

```
========================================
  /keepgo 执行完成
========================================

当前状态：{状态名称}
当前模块：{模块名}

本轮任务：
  {简述执行的内容}

执行结果：
  {关键改动，最多3行}

----------------------------------------
下一步：
  - /JVibe:keepgo
========================================
```

### 需要确认时

```
========================================
  /keepgo 需要确认
========================================

当前状态：{状态名称}
当前模块：{模块名}

待确认内容：
  {需要用户确认的内容}

[AskUserQuestion 组件显示]
========================================
```

---

## 示例流程

```
用户：/JVibe:keepgo
AI：检测到刚初始化，读取模块依赖，AuthModule 是底层模块
    开始为 AuthModule 规划功能...
    规划了 4 个功能：用户注册、用户登录、Token刷新、密码重置
    [请求确认]

用户：确认

用户：/JVibe:keepgo
AI：调用 planner agent，创建 F-001 到 F-004 的 TODO 列表

用户：/JVibe:keepgo
AI：调用 developer agent，开始 F-001 用户注册
    完成 TODO：设计 users 表结构

用户：/JVibe:keepgo
AI：继续 F-001，完成 TODO：实现注册 API

... (重复 keepgo)

用户：/JVibe:keepgo
AI：F-001 所有 TODO 完成
    [请求确认：功能是否符合预期]

用户：确认完成

用户：/JVibe:keepgo
AI：开始 F-002 用户登录...

... (循环直到模块完成)

用户：/JVibe:keepgo
AI：AuthModule 所有功能完成
    [请求确认：模块完成，进入下一模块]

用户：确认

用户：/JVibe:keepgo
AI：开始为 ProductModule 规划功能...
```

---

## 注意事项

1. **自动 commit**：每次执行完成后自动提交改动
2. **幂等性**：多次执行不会重复操作已完成的任务
3. **断点续传**：从上次中断的地方继续
4. **确认可跳过**：如果用户说"自动继续"，可以跳过确认环节
5. **状态同步**：每次执行前都重新读取文档状态

---

## 严禁输出

- ❌ 文档特点分析
- ❌ 项目架构说明
- ❌ 功能清单完整内容
- ❌ 代码详细解释
- ❌ "总结报告" / "工作总结"
