# /JVibe:migrate - 智能文档迁移

> 将旧版本 JVibe 文档智能迁移到新版本格式

## 触发场景

- 用户运行 `jvibe upgrade` 后提示需要 AI 迁移
- 用户主动运行 `/JVibe:migrate`
- 检测到文档格式与当前模板不匹配

## 工作流程

### 阶段 1：版本检测

1. 读取 `.claude/settings.json` 获取当前版本
2. 读取 `lib/migrations/index.js` 获取迁移配置（如果在 jvibe 包目录）
3. 或者读取以下文件判断版本特征：
   - `docs/core/Feature-List.md` 或 `docs/Feature-List.md`
   - `docs/core/Project.md` 或 `docs/Project.md`

### 阶段 2：变更分析

根据版本差异，识别需要迁移的内容：

#### 文档结构迁移（自动）
- `docs/*.md` → `docs/core/*.md`

#### 内容格式迁移（AI 介入）
检查以下变更：

**Feature-List.md 可能的变更**：
| 版本 | 变更 | 处理方式 |
|------|------|----------|
| 1.1.0 | 新增「优先级」字段 | AI 根据功能描述推断优先级 |
| 1.1.0 | 新增「预估工时」字段 | AI 根据 TODO 复杂度估算 |
| 1.1.0 | 新增「关联模块」字段 | AI 从项目文档中匹配模块 |

**Project.md 可能的变更**：
| 版本 | 变更 | 处理方式 |
|------|------|----------|
| 1.1.0 | 新增「环境配置」章节 | AI 扫描项目生成配置说明 |

### 阶段 3：执行迁移

#### 3.1 备份原文件

```bash
# 创建备份
cp docs/core/Feature-List.md docs/core/Feature-List.md.bak
cp docs/core/Project.md docs/core/Project.md.bak
```

#### 3.2 功能清单迁移

对每个功能条目：

1. **读取原有内容**：
   ```markdown
   ## F-001 ✅ 用户注册

   **描述**：允许新用户通过邮箱和密码创建账户...

   **TODO**
   - [x] 设计数据库users表结构
   - [x] 实现 POST /api/auth/register 端点
   ...
   ```

2. **智能补充新字段**：
   - **优先级**：根据功能描述判断（核心功能=P0，重要功能=P1，一般功能=P2，优化类=P3）
   - **预估工时**：根据 TODO 数量和复杂度估算
   - **关联模块**：从项目文档的模块清单中匹配

3. **生成新格式**：
   ```markdown
   ## F-001 ✅ 用户注册

   **描述**：允许新用户通过邮箱和密码创建账户...
   **优先级**：P0
   **预估工时**：8h
   **关联模块**：AuthModule

   **TODO**
   - [x] 设计数据库users表结构
   - [x] 实现 POST /api/auth/register 端点
   ...
   ```

#### 3.3 项目文档迁移

1. **保留原有章节**
2. **新增缺失章节**（如「环境配置」）
3. **更新模块功能统计**（从功能清单重新计算）

### 阶段 4：验证与确认

1. 展示迁移摘要：
   ```
   📋 迁移摘要

   Feature-List.md:
   - 更新了 15 个功能条目
   - 新增字段：优先级、预估工时、关联模块

   Project.md:
   - 新增章节：环境配置
   - 更新了模块功能统计

   备份位置：docs/core/*.md.bak
   ```

2. 询问用户确认

## 优先级推断规则

| 特征 | 优先级 |
|------|--------|
| 涉及认证、支付、核心业务流程 | P0 |
| 主要功能、用户高频使用 | P1 |
| 辅助功能、增强体验 | P2 |
| 优化、重构、技术债务 | P3 |

## 工时估算规则

| TODO 数量 | 复杂度特征 | 预估工时 |
|-----------|-----------|----------|
| 1-3 个 | 简单 CRUD | 2h |
| 4-6 个 | 包含测试 | 4h |
| 7-10 个 | 包含集成测试 | 8h |
| 10+ 个 | 复杂功能 | 16h+ |

## 模块匹配规则

1. 从功能编号范围推断（如 F-001~F-005 属于 AuthModule）
2. 从功能描述关键词匹配（如「认证」「登录」→ AuthModule）
3. 从 TODO 中的 API 路径推断（如 `/api/auth/*` → AuthModule）

## 错误处理

- 如果无法确定某个字段的值，使用占位符 `[待填写]`
- 如果文档格式无法识别，提示用户手动调整
- 保留所有备份文件，便于回滚

## 输出格式

迁移完成后输出：

```
✅ JVibe 文档迁移完成

📊 迁移统计：
- 功能清单：15 个功能条目已更新
- 项目文档：1 个新章节已添加

📝 新增字段：
- 优先级：15/15 已推断
- 预估工时：15/15 已估算
- 关联模块：15/15 已匹配

💾 备份文件：
- docs/core/Feature-List.md.bak
- docs/core/Project.md.bak

⚠️ 请检查以下需要手动确认的项目：
- F-007 用户资料编辑 - 优先级待确认
- F-015 在线状态显示 - 工时可能需要调整

运行 jvibe validate 验证迁移结果
```

## 权限

| 操作 | 权限 |
|------|------|
| 读取 | 所有文档 |
| 写入 | docs/core/*.md |
| 创建 | docs/core/*.md.bak（备份）|

## 相关命令

- `jvibe upgrade --check` - 检查是否需要迁移
- `jvibe upgrade` - 执行基础升级（不含内容迁移）
- `/JVibe:migrate` - 执行智能内容迁移
- `jvibe validate` - 验证迁移结果
