# [项目名称] 功能清单

> 最后更新: YYYY-MM-DD

## 📌 文档说明

本文档是**功能状态的唯一来源（SoT）**，详细描述每个功能的：
1. **功能描述** - 该功能是什么，解决什么问题
2. **实现TODO** - 具体的开发任务清单

**功能状态总览**: 见 [项目文档](./项目文档.md) §5 统计表（按 sprint/里程碑从本文档推导）

**编号规则**: F-XXX (F = Feature，XXX = 三位数字)

---

## 状态说明

- ✅ **已完成**: 功能开发完成、测试通过、已合并到主分支
- 🚧 **开发中**: 正在开发中，TODO未全部完成
- ❌ **未开始**: 已规划但尚未开始开发

> ⚠️ **重要**: 功能状态只在本文档维护，项目文档的统计数据由本文档推导。

---

# AuthModule (认证模块)

## F-001 ✅ 用户注册

**描述**：允许新用户通过邮箱和密码创建账户。注册成功后，系统自动发送验证邮件，用户需点击邮件中的链接完成邮箱验证。

**TODO**
- [x] 设计数据库users表结构
- [x] 实现 POST /api/auth/register 端点
- [x] 实现邮件发送服务
- [x] 实现邮箱验证端点 GET /api/auth/verify/:token
- [x] 单元测试（邮箱格式、密码强度、加密函数）
- [x] 集成测试（注册流程、异常情况）
- [x] API文档更新
- [x] 数据库Schema文档更新

---

## F-002 ✅ 用户登录

**描述**：已注册用户通过邮箱和密码登录系统，登录成功后获得访问令牌（Access Token）和刷新令牌（Refresh Token）。支持登录失败锁定机制。

**TODO**
- [x] 实现 POST /api/auth/login 端点
- [x] 实现登录失败计数器（Redis存储，5次失败锁定15分钟）
- [x] 实现auth_tokens表存储refreshToken
- [x] 单元测试（密码验证、Token生成、失败计数）
- [x] 集成测试（登录流程、失败场景、锁定机制）
- [x] API文档更新

---

## F-003 ✅ Token刷新

**描述**：当accessToken过期后，客户端可使用refreshToken获取新的accessToken，无需用户重新登录。

**TODO**
- [x] 实现 POST /api/auth/refresh 端点
- [x] 验证refreshToken有效性
- [x] 生成新的accessToken
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-004 ✅ 密码重置

**描述**：用户忘记密码时，可通过邮箱接收重置密码链接，点击链接后设置新密码。重置成功后旧token全部失效。

**TODO**
- [x] 实现 POST /api/auth/forgot-password 端点
- [x] 实现 POST /api/auth/reset-password 端点
- [x] 生成重置token（JWT，有效期1小时）
- [x] 发送重置密码邮件
- [x] 更新密码并使旧token失效
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-005 ✅ 邮箱验证

**描述**：用户注册后需要验证邮箱，验证成功后才能登录系统。支持重新发送验证邮件（1分钟内限制1次）。

**TODO**
- [x] 实现 GET /api/auth/verify/:token 端点
- [x] 实现 POST /api/auth/resend-verification 端点
- [x] 验证token有效性（24小时有效期）
- [x] 更新email_verified字段
- [x] 单元测试和集成测试
- [x] API文档更新

---

# UserModule (用户管理模块)

## F-006 ✅ 用户信息查询

**描述**：查询用户的基本信息和资料。支持查询自己的完整信息和其他用户的公开信息。

**TODO**
- [x] 实现 GET /api/users/:id 端点
- [x] 实现 GET /api/users/me 端点
- [x] 权限验证（需登录）
- [x] 区分公开信息和私密信息
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-007 ✅ 用户资料编辑

**描述**：用户可以编辑自己的资料，包括昵称（2-20字符）、简介（0-200字符）等信息。只能编辑自己的资料。

**TODO**
- [x] 实现 PUT /api/users/:id 端点
- [x] 请求体验证和字段长度验证
- [x] 权限验证（只能编辑自己）
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-008 ✅ 头像上传

**描述**：用户可以上传自己的头像图片，支持JPG、PNG格式（最大5MB），自动裁剪为正方形并生成200x200缩略图。

**TODO**
- [x] 实现 POST /api/users/:id/avatar 端点
- [x] 文件上传处理（multer）
- [x] 图片格式验证
- [x] 图片压缩和裁剪（sharp）
- [x] 上传到云存储（S3/OSS）
- [x] 更新user_profiles.avatar_url
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-009 ✅ 用户搜索

**描述**：通过关键词搜索用户，支持按昵称模糊搜索和按邮箱精确搜索，返回匹配的用户列表。支持分页（默认20条/页）。

**TODO**
- [x] 实现 GET /api/users/search 端点
- [x] 查询参数验证（q, page, limit）
- [x] 数据库模糊查询和分页逻辑
- [x] 权限验证（需登录）
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-010 ✅ 用户权限管理

**描述**：管理员可以设置用户的角色（user/admin），支持角色变更日志记录。防止自我提权。

**TODO**
- [x] 实现 PUT /api/users/:id/role 端点
- [x] 权限验证（需admin角色）
- [x] 防止自我提权
- [x] 记录角色变更日志
- [x] 单元测试和集成测试
- [x] API文档更新

---

# ChatModule (实时聊天模块)

## F-011 ✅ 创建聊天室

**描述**：用户可以创建聊天室，邀请其他用户加入。支持一对一聊天（direct，2人）和群聊（group，3-100人）。

**TODO**
- [x] 实现 POST /api/chat/rooms 端点
- [x] 聊天室类型验证（direct/group）
- [x] 成员列表验证（名称长度1-50字符）
- [x] 创建chat_rooms和room_members记录
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-012 ✅ 发送文本消息

**描述**：用户在聊天室内发送文本消息，消息实时推送给其他在线成员。

**TODO**
- [x] 实现 POST /api/chat/messages 端点
- [x] WebSocket消息广播逻辑
- [x] 消息内容验证和存储
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-013 ✅ 接收实时消息

**描述**：用户通过WebSocket连接实时接收聊天室消息，支持断线重连和消息补发。

**TODO**
- [x] 实现WebSocket连接管理
- [x] 实现消息推送逻辑
- [x] 实现断线重连机制
- [x] 实现消息补发逻辑
- [x] 单元测试和集成测试

---

## F-014 ✅ 历史消息查询

**描述**：查询聊天室的历史消息，支持分页加载（默认50条/页）和时间范围筛选。

**TODO**
- [x] 实现 GET /api/chat/messages/:roomId 端点
- [x] 分页查询逻辑
- [x] 时间范围筛选
- [x] 权限验证（只能查询已加入的聊天室）
- [x] 单元测试和集成测试
- [x] API文档更新

---

## F-015 ✅ 在线状态显示

**描述**：显示聊天室成员的在线状态（在线/离线/离开），通过WebSocket实时更新。

**TODO**
- [x] 实现在线状态管理（Redis存储）
- [x] WebSocket在线状态广播
- [x] 心跳检测机制
- [x] 单元测试和集成测试

---

## F-016 ✅ 输入状态指示

**描述**：显示其他用户正在输入的状态提示（"XXX正在输入..."），3秒无输入后自动清除。

**TODO**
- [x] WebSocket输入状态事件监听
- [x] 输入状态广播逻辑
- [x] 自动清除机制（3秒超时）
- [x] 单元测试和集成测试

---

## F-017 ✅ 消息通知

**描述**：用户离线或未打开聊天室时，收到新消息的系统通知（桌面通知/推送通知）。

**TODO**
- [x] 实现桌面通知（Web Notification API）
- [x] 实现推送通知服务集成
- [x] 通知开关和权限管理
- [x] 单元测试和集成测试

---

## F-018 🚧 文件分享

**描述**：用户可以在聊天室中分享文件（图片、文档、视频等），支持文件预览和下载。最大文件大小100MB。

**TODO**
- [x] 实现 POST /api/chat/files 端点
- [x] 文件上传处理（multer）
- [x] 文件类型验证和大小限制
- [x] 上传到云存储（S3/OSS）
- [ ] 图片预览缩略图生成
- [ ] 文件下载权限验证
- [ ] 单元测试和集成测试
- [ ] API文档更新

---

## F-019 ❌ 消息搜索

**描述**：在聊天室或全局范围内搜索历史消息，支持关键词搜索和高级筛选（发送人、时间范围、文件类型）。

**TODO**
- [ ] 实现 GET /api/chat/search 端点
- [ ] 全文搜索索引构建（Elasticsearch）
- [ ] 高级筛选逻辑（发送人、时间、文件类型）
- [ ] 搜索结果高亮显示
- [ ] 权限验证（只搜索有权限的聊天室）
- [ ] 单元测试和集成测试
- [ ] API文档更新

---

## F-020 ❌ 消息已读状态

**描述**：显示消息的已读状态，支持单聊的"已读/未读"标记和群聊的"X人已读"统计。

**TODO**
- [ ] 实现消息已读记录表（message_read_status）
- [ ] 实现 PUT /api/chat/messages/:id/read 端点
- [ ] WebSocket已读状态广播
- [ ] 群聊已读人数统计
- [ ] 未读消息计数功能
- [ ] 单元测试和集成测试
- [ ] API文档更新

---

**最后更新**: YYYY-MM-DD
