# [é¡¹ç›®åç§°] é¡¹ç›®æ–‡æ¡£

## ğŸ“Œ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£å¸®åŠ©AI Agentå¿«é€Ÿç†è§£ï¼š
1. é¡¹ç›®æ•´ä½“æ¶æ„
2. æœ‰å“ªäº›æ¨¡å—åŠå…¶èŒè´£è¾¹ç•Œ
3. æ¯ä¸ªæ¨¡å—çš„ä»£ç è½ç‚¹å’ŒåŠŸèƒ½ç´¢å¼•

**åŠŸèƒ½è¯¦ç»†ä¿¡æ¯åŠçŠ¶æ€**: æŸ¥çœ‹ [åŠŸèƒ½æ¸…å•](./Feature-List.md)ï¼ˆåŠŸèƒ½çŠ¶æ€çš„å”¯ä¸€æ¥æºï¼‰

---

## 1. é¡¹ç›®æ¶æ„å›¾

```mermaid
graph TD
    A[å‰ç«¯ Frontend] --> B[APIç½‘å…³]
    B --> C[è®¤è¯æ¨¡å— Auth]
    B --> D[ç”¨æˆ·æ¨¡å— User]
    B --> E[èŠå¤©æ¨¡å— Chat]

    C --> F[æ•°æ®åº“ PostgreSQL]
    D --> F
    E --> F

    E --> G[Redis ç¼“å­˜]
    E --> H[WebSocket æœåŠ¡]
```

---

## 2. æŠ€æœ¯æ ˆç‰ˆæœ¬

| åˆ†ç±» | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| **å‰ç«¯** | React | 18.2.0 |
| | TypeScript | 5.3.0 |
| | Vite | 5.0.0 |
| **åç«¯** | Node.js | 20.10.0 |
| | Express | 4.18.2 |
| | Prisma | 5.8.0 |
| **æ•°æ®åº“** | PostgreSQL | 15.5 |
| | Redis | 7.2.0 |
| **å…¶ä»–** | JWT | - |
| | Socket.io | 4.6.0 |

---

## 3. æ¨¡å—äº¤äº’å›¾

### 3.1 ä¾èµ–å…³ç³»

```mermaid
graph LR
    A[ChatModule] -->|ä¾èµ–| B[UserModule]
    A -->|ä¾èµ–| C[AuthModule]
    B -->|ä¾èµ–| C
```

### 3.2 æ•°æ®æµ

```mermaid
sequenceDiagram
    participant Frontend
    participant AuthModule
    participant ChatModule
    participant Database

    Frontend->>AuthModule: éªŒè¯Token
    AuthModule-->>Frontend: Tokenæœ‰æ•ˆ
    Frontend->>ChatModule: å‘é€æ¶ˆæ¯
    ChatModule->>Database: ä¿å­˜æ¶ˆæ¯
    ChatModule-->>Frontend: å¹¿æ’­æ¶ˆæ¯
```

---

## 4. æ¨¡å—æ¸…å•

### 4.0 å­—æ®µè§„èŒƒ

æ¯ä¸ªæ¨¡å—å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- **èŒè´£/è¾¹ç•Œ**
- **æ ¸å¿ƒæ¨¡å—**ï¼šæ˜¯/å¦
- **ä»£ç è½ç‚¹**
- **åŠŸèƒ½ç´¢å¼•**
- **ä¾èµ–** / **è¢«ä¾èµ–**

å¯é€‰å­—æ®µï¼ˆæŒ‰éœ€æ·»åŠ ï¼‰ï¼š
- **å¯¹å¤–æ¥å£**
- **æ•°æ®æ¨¡å‹**

### 4.1 AuthModule (è®¤è¯æ¨¡å—)

**èŒè´£/è¾¹ç•Œ**ï¼š
- å¤„ç†ç”¨æˆ·èº«ä»½è®¤è¯ï¼ˆæ³¨å†Œã€ç™»å½•ã€Tokenç®¡ç†ï¼‰
- æä¾›è®¤è¯ä¸­é—´ä»¶ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
- ä¸åŒ…å«ç”¨æˆ·èµ„æ–™ç®¡ç†ï¼ˆç”±UserModuleè´Ÿè´£ï¼‰

**æ ¸å¿ƒæ¨¡å—**ï¼šæ˜¯

**å¯¹å¤–æ¥å£**ï¼š
| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/api/auth/register` | POST | ç”¨æˆ·æ³¨å†Œ |
| `/api/auth/login` | POST | ç”¨æˆ·ç™»å½• |
| `/api/auth/refresh` | POST | åˆ·æ–°Token |
| `/api/auth/logout` | POST | ç”¨æˆ·ç™»å‡º |

**æ•°æ®æ¨¡å‹**ï¼š
| è¡¨å | ä¸»è¦å­—æ®µ | å…³é”®ç´¢å¼• |
|------|---------|---------|
| `users` | id, email, password_hash | email (UNIQUE) |
| `auth_tokens` | id, user_id, token, expires_at | user_id, token |

**ä»£ç è½ç‚¹**ï¼š
```
src/modules/auth/
â”œâ”€â”€ auth.controller.ts   # è·¯ç”±æ§åˆ¶å™¨
â”œâ”€â”€ auth.service.ts      # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ auth.middleware.ts   # è®¤è¯ä¸­é—´ä»¶
â””â”€â”€ jwt.util.ts          # JWTå·¥å…·å‡½æ•°
```

**åŠŸèƒ½ç´¢å¼•**ï¼š
| åŠŸèƒ½ç¼–å· | åŠŸèƒ½åç§° | è¯¦æƒ… |
|---------|---------|------|
| F-001 | ç”¨æˆ·æ³¨å†Œ | [æŸ¥çœ‹](./Feature-List.md#f-001-ç”¨æˆ·æ³¨å†Œ) |
| F-002 | ç”¨æˆ·ç™»å½• | [æŸ¥çœ‹](./Feature-List.md#f-002-ç”¨æˆ·ç™»å½•) |
| F-003 | Tokenåˆ·æ–° | [æŸ¥çœ‹](./Feature-List.md#f-003-tokenåˆ·æ–°) |

**ä¾èµ–**: æ— 
**è¢«ä¾èµ–**: UserModule, ChatModule

---

### 4.2 UserModule (ç”¨æˆ·ç®¡ç†æ¨¡å—)

**èŒè´£/è¾¹ç•Œ**ï¼š
- ç®¡ç†ç”¨æˆ·èµ„æ–™ï¼ˆæŸ¥è¯¢ã€ç¼–è¾‘ã€å¤´åƒï¼‰
- æä¾›ç”¨æˆ·æœç´¢åŠŸèƒ½
- ä¸åŒ…å«èº«ä»½è®¤è¯ï¼ˆç”±AuthModuleè´Ÿè´£ï¼‰

**æ ¸å¿ƒæ¨¡å—**ï¼šå¦

**å¯¹å¤–æ¥å£**ï¼š
| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|------|------|------|
| `/api/users/:id` | GET | è·å–ç”¨æˆ·ä¿¡æ¯ |
| `/api/users/:id` | PUT | æ›´æ–°ç”¨æˆ·èµ„æ–™ |
| `/api/users/:id/avatar` | POST | ä¸Šä¼ å¤´åƒ |
| `/api/users/search` | GET | æœç´¢ç”¨æˆ· |
| `/api/users/:id` | DELETE | åˆ é™¤ç”¨æˆ· |

**æ•°æ®æ¨¡å‹**ï¼š
| è¡¨å | ä¸»è¦å­—æ®µ | å…³é”®ç´¢å¼• |
|------|---------|---------|
| `user_profiles` | id, user_id, display_name, avatar_url | user_id (FK) |

**ä»£ç è½ç‚¹**ï¼š
```
src/modules/user/
â”œâ”€â”€ user.controller.ts   # è·¯ç”±æ§åˆ¶å™¨
â”œâ”€â”€ user.service.ts      # ä¸šåŠ¡é€»è¾‘
â””â”€â”€ user.repository.ts   # æ•°æ®è®¿é—®å±‚
```

**åŠŸèƒ½ç´¢å¼•**ï¼š
| åŠŸèƒ½ç¼–å· | åŠŸèƒ½åç§° | è¯¦æƒ… |
|---------|---------|------|

**ä¾èµ–**: AuthModule
**è¢«ä¾èµ–**: ChatModule

---

### 4.3 ChatModule (å®æ—¶èŠå¤©æ¨¡å—)

**èŒè´£/è¾¹ç•Œ**ï¼š
- ç®¡ç†èŠå¤©å®¤ï¼ˆåˆ›å»ºã€åŠ å…¥ã€ç¦»å¼€ï¼‰
- å¤„ç†æ¶ˆæ¯æ”¶å‘ï¼ˆæ–‡æœ¬ã€æ–‡ä»¶ï¼‰
- ç»´æŠ¤ç”¨æˆ·åœ¨çº¿çŠ¶æ€
- ä¸åŒ…å«ç”¨æˆ·è®¤è¯å’Œèµ„æ–™ç®¡ç†

**æ ¸å¿ƒæ¨¡å—**ï¼šå¦

**å¯¹å¤–æ¥å£**ï¼š
| ç«¯ç‚¹ | æ–¹æ³•/åè®® | ç”¨é€” |
|------|----------|------|
| `/api/chat/rooms` | POST | åˆ›å»ºèŠå¤©å®¤ |
| `/api/chat/rooms` | GET | è·å–èŠå¤©å®¤åˆ—è¡¨ |
| `/api/chat/messages/:roomId` | GET | è·å–å†å²æ¶ˆæ¯ |
| `/api/chat/rooms/:id/join` | POST | åŠ å…¥èŠå¤©å®¤ |
| `/ws/chat` | WebSocket | å®æ—¶æ¶ˆæ¯é€šä¿¡ |

**æ•°æ®æ¨¡å‹**ï¼š
| è¡¨å | ä¸»è¦å­—æ®µ | å…³é”®ç´¢å¼• |
|------|---------|---------|
| `chat_rooms` | id, name, type, created_at | name |
| `messages` | id, room_id, sender_id, content, sent_at | room_id, sender_id, sent_at |
| `room_members` | id, room_id, user_id, joined_at | room_id, user_id |

**ä»£ç è½ç‚¹**ï¼š
```
src/modules/chat/
â”œâ”€â”€ chat.controller.ts      # è·¯ç”±æ§åˆ¶å™¨
â”œâ”€â”€ chat.service.ts         # ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ websocket.gateway.ts    # WebSocketå¤„ç†
â””â”€â”€ message.repository.ts   # æ¶ˆæ¯æ•°æ®è®¿é—®
```

**åŠŸèƒ½ç´¢å¼•**ï¼š
| åŠŸèƒ½ç¼–å· | åŠŸèƒ½åç§° | è¯¦æƒ… |
|---------|---------|------|

**ä¾èµ–**: UserModule, AuthModule
**è¢«ä¾èµ–**: æ— 

---

## 5. æ¨¡å—åŠŸèƒ½ç»Ÿè®¡

> âš ï¸ **æ•°æ®æ¥æº**ï¼šä»¥ [åŠŸèƒ½æ¸…å•](./Feature-List.md) ä¸­çš„çŠ¶æ€ä¸ºå‡†ï¼Œæœ¬è¡¨æŒ‰ sprint/é‡Œç¨‹ç¢‘å‘¨æœŸæ€§æ›´æ–°ã€‚

| æ¨¡å— | åŠŸèƒ½æ€»æ•° | å·²å®Œæˆ | å¼€å‘ä¸­ | æœªå¼€å§‹ | å®Œæˆç‡ |
|------|---------|--------|--------|--------|--------|
| AuthModule | 5 | 5 | 0 | 0 | 100% |
| UserModule | 5 | 5 | 0 | 0 | 100% |
| ChatModule | 10 | 7 | 1 | 2 | 70% |
| **æ€»è®¡** | **20** | **17** | **1** | **2** | **85%** |

**çŠ¶æ€å›¾ä¾‹**ï¼ˆå®šä¹‰è§åŠŸèƒ½æ¸…å•ï¼‰ï¼š
- âœ… å·²å®Œæˆ: åŠŸèƒ½å¼€å‘å®Œæˆã€æµ‹è¯•é€šè¿‡ã€å·²åˆå¹¶
- ğŸš§ å¼€å‘ä¸­: æ­£åœ¨å¼€å‘ä¸­
- âŒ æœªå¼€å§‹: å·²è§„åˆ’ä½†æœªå¼€å§‹

---

## 6. æ•°æ®åº“è¡¨æ€»è§ˆ

| è¡¨å | æ‰€å±æ¨¡å— | ä¸»è¦å­—æ®µ | å…³é”®ç´¢å¼• |
|------|---------|---------|---------|
| users | AuthModule | id, email, password_hash | email (UNIQUE) |
| auth_tokens | AuthModule | id, user_id, token, expires_at | user_id, token |
| user_profiles | UserModule | id, user_id, display_name, avatar_url | user_id (FK) |
| chat_rooms | ChatModule | id, name, type, created_at | name |
| messages | ChatModule | id, room_id, sender_id, content, sent_at | room_id, sender_id, sent_at |
| room_members | ChatModule | id, room_id, user_id, joined_at | room_id, user_id |

---

## 7. ç¯å¢ƒé…ç½®

| é¡¹ç›®é¡¹ | å€¼ | è¯´æ˜ |
|------|----|------|
| é¡¹ç›®æ ¹è·¯å¾„ | `[è‡ªåŠ¨å¡«å……]` | è¿è¡Œ `pwd` æˆ–è¯†åˆ« `.git/.claude` æ‰€åœ¨ç›®å½• |
| ä»£ç æ ¹è·¯å¾„ | `[è‡ªåŠ¨å¡«å……]` | å¸¸è§ä¸º `src/`ï¼Œè‹¥æ— åˆ™ä¸ºé¡¹ç›®æ ¹ |
