# Vibe 核心开发流程

> 专注"如何开发好一个功能"，从需求到代码合并

## 阶段总览

```
需求评审 ──→ 规划设计 ──→ 功能开发 ──→ 代码审查 ──→ 集成测试 ──→ 文档同步 ──→ 代码合并 ✅
  (1-2天)     (2-3天)     (3-7天)     (1天)       (1-2天)     (0.5天)
```

**流程范围**：从需求接入到代码合并到主分支
**流程边界**：不包含部署、监控、运维（属于DevOps范畴）

---

## 📐 阶段一：规划设计 (Planning & Design)

### 触发条件
- 需求评审通过
- 功能清单条目已创建
- 架构影响已明确

### 输入
- 需求卡片 (REQ-XXX)
- 需求评审结论
- 相关的ADR记录（如有）

### 核心任务

#### 1.1 技术方案设计
创建技术方案文档 `tech-spec/FEATURE-XXX.md`:

```markdown
# Feature-XXX 技术方案

## 1. 需求概述
[简要描述需求]

## 2. 架构设计

### 2.1 模块划分
- **新增模块**: [模块名称]
  - 职责: [单一职责描述]
  - 依赖: [依赖的其他模块]
  - 提供能力: [对外暴露的接口]

### 2.2 模块交互图
\`\`\`mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Database

    User->>Frontend: 操作
    Frontend->>Backend: API请求
    Backend->>Database: 查询/更新
    Database-->>Backend: 返回结果
    Backend-->>Frontend: 响应
    Frontend-->>User: 展示
\`\`\`

### 2.3 数据模型设计
\`\`\`sql
CREATE TABLE feature_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    data JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_feature_data_user_id ON feature_data(user_id);
\`\`\`

### 2.4 API设计
\`\`\`yaml
POST /api/v1/feature
Request:
  {
    "field1": "string",
    "field2": 123
  }
Response:
  {
    "id": "uuid",
    "status": "success"
  }
\`\`\`

## 3. 实现细节

### 3.1 核心算法/逻辑
[描述关键算法或业务逻辑]

### 3.2 异常处理策略
- **场景A**: 处理方式
- **场景B**: 处理方式

### 3.3 性能优化点
- 缓存策略: [...]
- 查询优化: [...]

## 4. 测试策略

### 4.1 单元测试
- [ ] 测试核心函数XXX
- [ ] 测试边界条件
- [ ] 测试异常情况

### 4.2 集成测试
- [ ] 测试API端到端流程
- [ ] 测试与其他模块的交互

### 4.3 性能测试
- [ ] 响应时间目标: <200ms
- [ ] 并发支持目标: 1000 QPS

## 5. 风险评估
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 第三方API不稳定 | 高 | 中 | 实现降级方案 |

## 6. 排期预估
- 开发: 3天
- 测试: 1天
- 联调: 1天
- 总计: 5天
```

#### 1.2 更新项目文档
根据架构影响级别：

**重大架构变更**:
- 创建ADR记录
- 更新项目文档的架构视图
- 更新模块协作矩阵
- 召开架构评审会议

**小幅架构调整**:
- 更新项目文档的模块协作矩阵
- 更新接口契约部分

#### 1.3 任务拆解
在功能清单中填充实现TODO:
```markdown
### ✅ 实现TODO
- [ ] 数据库迁移脚本编写
- [ ] 后端API实现
  - [ ] 路由定义
  - [ ] Controller层
  - [ ] Service层
  - [ ] Repository层
- [ ] 前端实现
  - [ ] 页面组件开发
  - [ ] 状态管理
  - [ ] API调用集成
- [ ] 单元测试 (目标覆盖率 80%)
- [ ] 集成测试
- [ ] 文档更新
```

### 输出
- ✅ 技术方案文档 (`tech-spec/FEATURE-XXX.md`)
- ✅ 项目文档更新PR (如适用)
- ✅ ADR记录 (如适用)
- ✅ 功能清单TODO已填充

### Definition of Done (DoD)
- [ ] 技术方案经过技术负责人Review
- [ ] 数据模型设计符合数据库规范（见附加材料#DB-Schema-Design）
- [ ] API设计符合RESTful规范
- [ ] 性能指标明确且可测量
- [ ] 风险已识别并有缓解措施
- [ ] 排期合理且团队已知晓

---

## 💻 阶段二：功能开发 (Implementation)

### 触发条件
- 技术方案已通过Review
- 依赖的功能已完成（如有）
- 开发环境就绪

### 输入
- 技术方案文档
- 功能清单TODO
- 相关代码规范（附加材料）

### 核心任务

#### 2.1 创建功能分支
```bash
# 分支命名规范
git checkout -b feature/FEATURE-XXX-短描述

# 示例
git checkout -b feature/FEATURE-001-user-auth
```

#### 2.2 开发实现
**遵循原则**:
- **SOLID**: 每个类/模块单一职责，依赖抽象不依赖具体
- **DRY**: 提取公共逻辑到工具函数/服务
- **KISS**: 优先选择简单实现，避免过度设计
- **YAGNI**: 只实现当前需要的功能，不预留"未来可能"的扩展

**开发检查清单**:
- [ ] 代码遵循项目代码风格指南
- [ ] 关键逻辑添加注释
- [ ] 异常情况有适当的错误处理
- [ ] 敏感信息（密钥、密码）不硬编码
- [ ] 日志记录适当（关键操作、异常）
- [ ] 避免常见安全漏洞（SQL注入、XSS、CSRF）

#### 2.3 编写测试
**测试金字塔**:
```
        /\
       /E2E\        少量 - 端到端场景
      /------\
     /  集成  \      适量 - 模块间交互
    /----------\
   /   单元测试  \   大量 - 函数/类级别
  /--------------\
```

**测试覆盖要求**:
- 单元测试覆盖率 ≥ 80%
- 核心业务逻辑必须有集成测试
- 关键用户流程必须有E2E测试

**测试用例模板**:
```typescript
describe('UserAuthService', () => {
  describe('register', () => {
    it('应该成功注册新用户', async () => {
      // Arrange: 准备测试数据
      const userData = { email: 'test@example.com', password: 'Test123!' };

      // Act: 执行操作
      const result = await authService.register(userData);

      // Assert: 验证结果
      expect(result.id).toBeDefined();
      expect(result.email).toBe(userData.email);
    });

    it('应该拒绝重复的邮箱', async () => {
      // ...
    });

    it('应该拒绝弱密码', async () => {
      // ...
    });
  });
});
```

#### 2.4 本地自测
```bash
# 运行测试
npm test

# 检查代码风格
npm run lint

# 检查类型（如TypeScript）
npm run type-check

# 构建检查
npm run build
```

### 输出
- ✅ 功能代码
- ✅ 单元测试（覆盖率≥80%）
- ✅ 集成测试
- ✅ 本地自测通过

### Definition of Done (DoD)
- [ ] 所有功能清单TODO已完成
- [ ] 测试覆盖率达标
- [ ] 本地测试全部通过
- [ ] 代码风格检查通过
- [ ] 构建成功无错误
- [ ] 无控制台错误/警告
- [ ] 性能指标达到预期（如有）

---

## 🔍 阶段三：代码审查 (Code Review)

### 触发条件
- 开发阶段DoD全部满足
- 功能分支已推送到远程
- PR已创建

### 输入
- Pull Request
- 技术方案文档
- 功能清单

### PR模板
```markdown
## 关联功能
- Feature: #FEATURE-XXX
- 需求: REQ-YYYY-MM-NNN

## 变更描述
[简要描述本次PR的主要变更]

## 变更类型
- [ ] 新功能
- [ ] Bug修复
- [ ] 性能优化
- [ ] 重构
- [ ] 文档更新
- [ ] 测试补充

## 架构影响
- [ ] 无架构影响
- [ ] 新增模块: [模块名]
- [ ] 修改接口: [接口列表]
- [ ] 数据库变更: [变更说明]

## 测试情况
- [ ] 单元测试通过 (覆盖率: XX%)
- [ ] 集成测试通过
- [ ] 本地功能验证通过
- [ ] 性能测试通过 (如适用)

## 截图/演示
[如果是UI变更，附上截图或GIF]

## 注意事项
[需要Reviewer特别关注的地方]

## Checklist
- [ ] 代码遵循项目规范
- [ ] 已添加必要的测试
- [ ] 文档已更新（如适用）
- [ ] 无遗留的TODO/FIXME
- [ ] 已自测所有变更
```

### 审查清单

#### 3.1 代码质量审查
**架构层面**:
- [ ] 是否符合技术方案设计？
- [ ] 是否遵循SOLID原则？
- [ ] 模块职责是否清晰单一？
- [ ] 依赖关系是否合理？

**代码层面**:
- [ ] 是否有重复代码（DRY）？
- [ ] 是否有过度设计（KISS）？
- [ ] 是否有未使用的代码（YAGNI）？
- [ ] 命名是否清晰表达意图？
- [ ] 函数是否过长（建议<50行）？
- [ ] 类是否过大（建议<300行）？

**安全层面**:
- [ ] 是否有SQL注入风险？
- [ ] 是否有XSS风险？
- [ ] 敏感数据是否加密？
- [ ] 用户输入是否验证？
- [ ] 认证授权是否正确？

**性能层面**:
- [ ] 是否有N+1查询？
- [ ] 是否有不必要的循环嵌套？
- [ ] 大数据集是否分页处理？
- [ ] 是否有内存泄漏风险？

#### 3.2 测试审查
- [ ] 测试覆盖率是否达标？
- [ ] 是否测试了边界条件？
- [ ] 是否测试了异常情况？
- [ ] 测试是否独立可重复？
- [ ] Mock是否合理？

#### 3.3 文档审查
- [ ] 技术方案与实现是否一致？
- [ ] 复杂逻辑是否有注释？
- [ ] API变更是否更新了接口文档？

### 审查反馈处理
**反馈分类**:
- 🔴 **Must Fix**: 阻塞合并，必须修改
- 🟡 **Should Fix**: 强烈建议修改，但不阻塞
- 🟢 **Nice to Have**: 可选的改进建议

**处理流程**:
1. 开发者修复所有"Must Fix"问题
2. 开发者回复每条评论（已修复/说明原因）
3. Reviewer复审
4. 通过后合并

### 输出
- ✅ 代码审查通过
- ✅ 所有Must Fix问题已解决
- ✅ 准备合并到主分支

### Definition of Done (DoD)
- [ ] 至少1位Reviewer批准
- [ ] 所有代码审查意见已处理
- [ ] CI/CD流水线全部通过
- [ ] 无未解决的代码冲突

---

## 🧪 阶段四：集成测试 (Integration Testing)

### 触发条件
- PR已合并到主分支/测试分支
- 测试环境已部署最新代码

### 输入
- 已合并的代码
- 测试用例清单
- 验收标准（来自需求卡片）

### 核心任务

#### 4.1 功能验证
逐项验证需求卡片中的验收标准:
```markdown
## 验收标准验证
- [x] ✅ 用户可以通过邮箱注册
- [x] ✅ 密码强度验证正常工作
- [x] ✅ 注册后自动登录
- [ ] ❌ Token过期后自动刷新 (Bug: #BUG-001)
```

#### 4.2 集成场景测试
测试跨模块的完整业务流程:
```markdown
## 测试场景: 用户注册到首次使用完整流程
1. 访问注册页面
2. 填写注册信息
3. 提交注册
4. 验证邮箱（如适用）
5. 自动登录
6. 进入主页面
7. 执行首次操作

预期结果: [...]
实际结果: [...]
状态: ✅ 通过 / ❌ 失败
```

#### 4.3 兼容性测试（如适用）
- [ ] 浏览器兼容性（Chrome, Firefox, Safari）
- [ ] 移动端适配
- [ ] 不同数据库版本
- [ ] API向后兼容性

#### 4.4 性能测试（关键功能）
```bash
# 使用k6或类似工具进行压测
k6 run --vus 100 --duration 30s performance-test.js

# 验证指标
# - 平均响应时间 < 200ms
# - P95响应时间 < 500ms
# - 错误率 < 1%
```

### 缺陷处理流程
发现Bug时:
1. 创建Bug单 (`BUG-XXX`)
2. 记录复现步骤、预期/实际结果
3. 评估严重程度:
   - **P0 (阻断)**: 功能完全不可用，必须立即修复
   - **P1 (严重)**: 核心功能受影响，需优先修复
   - **P2 (一般)**: 非核心功能问题，可排期修复
   - **P3 (轻微)**: 体验问题，可延后修复
4. P0/P1 Bug必须修复后才能合并

### 输出
- ✅ 验收标准全部通过
- ✅ 集成测试报告
- ✅ 性能测试报告（如适用）
- ✅ 缺陷清单及处理状态

### Definition of Done (DoD)
- [ ] 所有验收标准验证通过
- [ ] 无P0/P1级别的未解决Bug
- [ ] 性能指标达到预期（如适用）
- [ ] 测试报告已归档

---

## 📚 阶段五：文档同步 (Documentation Sync)

### 触发条件
- 集成测试通过
- 准备合并到主分支

### 输入
- 代码变更记录
- 功能清单
- 技术方案文档

### 核心任务

#### 5.1 判断文档更新需求
根据变更类型自动判断:

| 变更类型 | 需要更新的文档 |
|---------|--------------|
| 新增核心模块 | 项目文档 - 模块协作矩阵 |
| API新增/变更 | API文档、接口契约 |
| 数据库Schema变更 | 数据模型文档 |
| 用户可见功能 | README、用户手册 |
| 配置项变更 | 配置说明文档 |
| 技术栈变更 | 项目文档 - 技术架构层 |

#### 5.2 更新相关文档
**项目文档更新**:
```markdown
## 模块协作矩阵 (新增行)
| 用户认证模块 | 用户模块, 邮件模块 | 提供JWT认证能力 | REST API | AuthDTO |
```

**API文档更新**:
```markdown
## POST /api/v1/auth/register
创建新用户账户

### 请求
\`\`\`json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
\`\`\`

### 响应
\`\`\`json
{
  "id": "uuid",
  "email": "user@example.com",
  "token": "jwt_token"
}
\`\`\`

### 错误码
- 400: 邮箱格式错误
- 409: 邮箱已存在
- 500: 服务器错误
```

**CHANGELOG更新**:
```markdown
## [Unreleased]

### Added
- 用户注册和登录功能 (#FEATURE-001)
- JWT token认证机制

### Changed
- 优化了数据库查询性能 (#FEATURE-002)

### Fixed
- 修复了XXX情况下的崩溃问题 (#BUG-001)
```

#### 5.3 文档审查
- [ ] 文档与代码实现一致
- [ ] 示例代码可运行
- [ ] 链接有效
- [ ] 术语统一

### 输出
- ✅ 相关文档已更新
- ✅ CHANGELOG已更新
- ✅ 文档PR已合并（如适用）

### Definition of Done (DoD)
- [ ] 所有受影响的文档已更新
- [ ] 文档经过Review确认准确
- [ ] CHANGELOG符合格式规范
- [ ] 文档变更已提交

---

## ✅ 最终检查：代码合并

### 合并前终极检查清单

#### 代码质量
- [ ] 所有CI检查通过
- [ ] 所有代码审查意见已解决
- [ ] 无merge冲突
- [ ] 分支与主分支同步

#### 测试
- [ ] 单元测试通过 (覆盖率≥80%)
- [ ] 集成测试通过
- [ ] E2E测试通过 (如适用)
- [ ] 性能测试通过 (如适用)

#### 文档
- [ ] 文档已更新
- [ ] CHANGELOG已更新
- [ ] 功能清单状态已更新为"已完成"

#### 技术方案
- [ ] 实现与技术方案一致
- [ ] 所有风险缓解措施已实施
- [ ] 性能指标达到预期

### 合并操作
```bash
# 确认当前分支
git branch

# 合并到主分支（通常由PR自动完成）
# 如需手动合并：
git checkout main
git merge feature/FEATURE-XXX --no-ff
git push origin main

# 更新功能清单状态
# 标记为"已完成"
```

### 合并后
- ✅ 代码已合并到主分支
- ✅ 功能清单状态更新为"已完成"
- ✅ 功能分支可删除（可选）
- ✅ 通知相关团队成员

---

## 📋 快速参考：完整检查清单

### 开发前
- [ ] 需求评审通过
- [ ] 技术方案设计完成
- [ ] 项目文档已更新（如适用）
- [ ] 功能清单TODO已拆解

### 开发中
- [ ] 创建功能分支
- [ ] 遵循代码规范
- [ ] 编写单元测试（覆盖率≥80%）
- [ ] 本地自测通过

### 开发后
- [ ] 创建PR并填写模板
- [ ] 代码审查通过
- [ ] 集成测试通过
- [ ] 文档已更新
- [ ] 合并前检查通过
- [ ] 代码已合并到主分支

---

## 🔄 异常处理流程

### 开发阶段发现需求不合理
1. 立即与需求提出人沟通
2. 如需变更技术方案 → 更新tech-spec并重新Review
3. 如需变更需求 → 更新需求卡片并重新评审

### 测试阶段发现严重Bug
1. 创建BUG单并标记为P0
2. 开发者优先修复
3. 修复后重新走完整测试流程

### 代码审查无法通过
1. 与Reviewer沟通理解问题
2. 修复所有Must Fix问题
3. 对Should Fix问题给出解释或修复
4. 重新提交Review

---

## 🎯 核心原则总结

### SOLID原则
- **S - 单一职责**: 每个模块/类/函数只做一件事
- **O - 开闭原则**: 对扩展开放，对修改封闭
- **L - 里氏替换**: 子类可以替换父类
- **I - 接口隔离**: 接口应该小而专一
- **D - 依赖倒置**: 依赖抽象而非具体实现

### DRY原则
避免代码重复，提取公共逻辑

### KISS原则
保持简单，避免过度设计

### YAGNI原则
只实现当前需要的功能

---

**流程终点**：代码合并到主分支
**不包含**：部署、监控、运维（由DevOps团队负责）
**关键价值**：确保代码质量、可维护性、可测试性
